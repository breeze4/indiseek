{"answer":"When a CSS file changes in a Vite project, the Hot Module Replacement (HMR) process follows a specific propagation path managed by the Vite dev server and the browser client.\n\n### 1. File Change Detection and Context Initialization\nWhen a file is modified, the Vite dev server's watcher triggers `handleHMRUpdate` in `packages/vite/src/node/server/hmr.ts`.\n- Vite identifies the affected modules using the `moduleGraph`.\n- For CSS files, the corresponding `EnvironmentModuleNode` has its `type` set to `'css'` (determined in the constructor in `packages/vite/src/node/server/moduleGraph.ts`).\n\n### 2. Update Propagation\nThe server then calls `updateModules`, which invokes `propagateUpdate` to determine how the change affects the module graph.\n- **Self-Acceptance**: CSS modules are generally treated as **self-accepting**. During the transformation phase, the CSS plugin ensures these modules are marked so they can handle their own updates without requiring a parent JS module to reload.\n- **Boundary Discovery**: `propagateUpdate` (in `packages/vite/src/node/server/hmr.ts`) traverses the graph. Since CSS nodes are marked as self-accepting, they act as HMR boundaries.\n- **Update Payload**: The server constructs an update payload where the type is dynamically assigned as `` `${boundary.type}-update` ``. For CSS, this results in a `css-update` payload.\n\n### 3. Handling CSS @import Dependencies\nVite handles CSS-to-CSS dependencies (via `@import`) through the `vite:css-analysis` plugin (in `packages/vite/src/node/plugins/css.ts`):\n- When a CSS file is transformed, Vite tracks its `@import` dependencies.\n- If an imported CSS file changes, the plugin's HMR logic ensures that the importer (the \"parent\" CSS file) is also invalidated and included in the HMR update. This ensures that styles compounded across multiple files stay in sync.\n\n### 4. Client-Side Execution\nThe server sends the `css-update` payload via WebSockets to the Vite client-side runtime (`packages/vite/src/client/client.ts`).\n- **Style Swapping**: The client identifies the `<style>` or `<link>` tags associated with the updated CSS module ID.\n- **Cache Busting**: It fetches the new version of the CSS by appending a timestamp query parameter (e.g., `?t=123456789`) to the URL.\n- **DOM Update**:\n    - If it's a **linked stylesheet**, the `href` is updated to the new URL.\n    - If it's **inlined/processed CSS**, the old `<style>` tag is replaced with a new one containing the updated content.\n- This process allows the styles to update instantly without losing the application's state (unlike a full page reload).\n\n### 5. Integration with JS\nIf the CSS is imported into a JS file (e.g., `import './style.css'`), Vite typically serves a \"proxy\" JS module for that CSS. The HMR update still targets the CSS resource specifically, but the proxy ensures that the dependency relationship is maintained in the `moduleGraph` so that if the CSS is removed or its export name (in CSS Modules) changes, the importing JS module is correctly notified.","evidence":[{"step":"search_code(query='CSS HMR propagation')","detail":"Search results for 'CSS HMR propagation' (10 result(s)):\n\n  1. packages/vite/src/node/plugins/css.ts [handler] (method, semantic)\n     Score: 0.0164\n     | async handler(_, id) {\n     |         const ..."},{"step":"search_code(query='handleHotUpdate CSS')","detail":"Search results for 'handleHotUpdate CSS' (10 result(s)):\n\n  1. packages/vite/src/client/client.ts [createModuleHotContext] (method, semantic)\n     Score: 0.0164\n     | override createModuleHotContext(..."},{"step":"read_file(path='packages/vite/src/node/plugins/css.ts')","detail":"File: packages/vite/src/node/plugins/css.ts\n────────────────────────────────────────────────────────────\n     1 | import fs from 'node:fs'\n     2 | import fsp from 'node:fs/promises'\n     3 | import p..."},{"step":"search_code(query='handleHotUpdate path:packages/vite/src/node/plugins/css.ts')","detail":"Search results for 'handleHotUpdate' (10 result(s)):\n\n  1. packages/vite/src/node/__tests__/plugins/hooks.spec.ts [handleHotUpdate] (method, semantic)\n     Score: 0.0164\n     | handleHotUpdate() {\n   ..."},{"step":"read_file(end_line=150, start_line=1, path='packages/vite/src/node/server/hmr.ts')","detail":"File: packages/vite/src/node/server/hmr.ts (lines 1-150)\n────────────────────────────────────────────────────────────\n     1 | import fsp from 'node:fs/promises'\n     2 | import path from 'node:path'\n..."},{"step":"read_file(path='packages/vite/src/node/server/hmr.ts', start_line=151, end_line=350)","detail":"File: packages/vite/src/node/server/hmr.ts (lines 151-350)\n────────────────────────────────────────────────────────────\n   151 |   on(event: 'connection', listener: () => void): void\n   152 |   /**\n  ..."},{"step":"read_file(end_line=600, start_line=351, path='packages/vite/src/node/server/hmr.ts')","detail":"File: packages/vite/src/node/server/hmr.ts (lines 351-600)\n────────────────────────────────────────────────────────────\n   351 |         }\n   352 |       }\n   353 |       sortedPlugins.splice(pre + no..."},{"step":"read_file(end_line=800, start_line=601, path='packages/vite/src/node/server/hmr.ts')","detail":"File: packages/vite/src/node/server/hmr.ts (lines 601-800)\n────────────────────────────────────────────────────────────\n   601 |             `(${environment.name}) [no modules matched] ${colors.dim(sh..."},{"step":"read_file(start_line=1, end_line=100, path='packages/vite/src/node/server/moduleGraph.ts')","detail":"File: packages/vite/src/node/server/moduleGraph.ts (lines 1-100)\n────────────────────────────────────────────────────────────\n     1 | import { extname } from 'node:path'\n     2 | import type { Module..."},{"step":"search_code(query='isSelfAccepting = true')","detail":"Search results for 'isSelfAccepting = true' (10 result(s)):\n\n  1. packages/vite/src/node/server/mixedModuleGraph.ts [isSelfAccepting] (method, semantic)\n     Score: 0.0164\n     | get isSelfAccepting()..."},{"step":"search_code(query='isSelfAccepting = true path:packages/vite/src/node/plugins/css.ts')","detail":"[Cache hit — similar query already executed]\nSearch results for 'isSelfAccepting = true' (10 result(s)):\n\n  1. packages/vite/src/node/server/mixedModuleGraph.ts [isSelfAccepting] (method, semantic)\n  ..."},{"step":"search_code(query='Handle CSS @import dependency HMR')","detail":"Search results for 'Handle CSS @import dependency HMR' (10 result(s)):\n\n  1. packages/vite/src/node/plugins/css.ts [cssAnalysisPlugin] (function, semantic)\n     Score: 0.0164\n     | function cssAnalys..."},{"step":"read_file(start_line=1, path='packages/vite/src/node/plugins/importAnalysis.ts')","detail":"File: packages/vite/src/node/plugins/importAnalysis.ts (lines 1-1132)\n────────────────────────────────────────────────────────────\n     1 | import path from 'node:path'\n     2 | import fs from 'node:f..."},{"step":"read_file(end_line=1132, start_line=600, path='packages/vite/src/node/plugins/importAnalysis.ts')","detail":"File: packages/vite/src/node/plugins/importAnalysis.ts (lines 600-1132)\n────────────────────────────────────────────────────────────\n   600 |                   environment,\n   601 |                   ..."},{"step":"search_code(query='function cssAnalysisPlugin')","detail":"Search results for 'function cssAnalysisPlugin' (10 result(s)):\n\n  1. packages/vite/src/node/plugins/css.ts [cssPlugin] (function, semantic)\n     Score: 0.0164\n     | function cssPlugin(config: Resolv..."},{"step":"search_code(query='function cssAnalysisPlugin(config: ResolvedConfig): Plugin {')","detail":"Search results for 'function cssAnalysisPlugin(config: ResolvedConfig): Plugin {' (10 result(s)):\n\n  1. packages/vite/src/node/plugins/css.ts [cssAnalysisPlugin] (function, semantic)\n     Score: 0.016..."},{"step":"search_code(query='function cssAnalysisPlugin(config: ResolvedConfig): Plugin')","detail":"[Cache hit — similar query already executed]\nSearch results for 'function cssAnalysisPlugin(config: ResolvedConfig): Plugin {' (10 result(s)):\n\n  1. packages/vite/src/node/plugins/css.ts [cssAnalysisP..."},{"step":"search_code(query=\"name: 'vite:css-analysis'\")","detail":"Search results for 'name: 'vite:css-analysis'' (10 result(s)):\n\n  1. packages/vite/src/node/plugins/css.ts [cssPlugin] (function, semantic)\n     Score: 0.0164\n     | function cssPlugin(config: Resolve..."}]}