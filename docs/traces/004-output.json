{"answer":"Vite handles Hot Module Replacement (HMR) for CSS files using two distinct paths depending on how the CSS is integrated into the application: **Direct CSS** (via `<link>` tags) and **JS-imported CSS** (via `import` statements).\n\n### 1. Detection and Server-Side Propagation\nWhen a CSS file changes, Vite's HMR process begins in `packages/vite/src/node/server/hmr.ts`:\n- **Module Identification**: The server identifies the affected modules in the `ModuleGraph` using `moduleGraph.getModulesByFile(file)`.\n- **Propagation**: The `propagateUpdate` function traverses the importer chain.\n    - **Self-Acceptance**: Most CSS files are considered \"self-accepting.\" For JS-imported CSS, the `cssPostPlugin` injects `import.meta.hot.accept()`. For direct CSS requests, they are marked as self-accepting in the module graph by the `cssAnalysisPlugin` (`packages/vite/src/node/plugins/css.ts`, line 1170).\n    - **CSS Modules**: Unlike standard CSS, **CSS Modules** are typically *not* self-accepting because they export JS constants. A change here propagates to the JS modules that import them.\n- **Payload Construction**: The server constructs an HMR payload:\n    - If the module `type` is `'css'`, it sends a `css-update`.\n    - If the module `type` is `'js'` (standard for `import './style.css'`), it sends a `js-update`.\n\n### 2. The \"Direct CSS\" Path (`css-update`)\nThis path is used for CSS referenced via `<link rel=\"stylesheet\">` or requested with the `?direct` query.\n- **Payload**: `{ type: 'update', updates: [{ type: 'css-update', path: '...', timestamp: ... }] }`\n- **Client Handling**: In `packages/vite/src/client/client.ts` (line 227), the client:\n    1. Locates the existing `<link>` tag matching the updated file path.\n    2. Creates a **new** `<link>` element with the same attributes but an updated timestamp query parameter (e.g., `style.css?t=123456789`) to bypass browser cache.\n    3. Appends the new link after the old one.\n    4. **Avoids FOUC**: It waits for the `load` event of the new stylesheet before removing the old `<link>` tag, ensuring a seamless transition without a Flash of Unstyled Content.\n\n### 3. The \"JS-Imported CSS\" Path (`js-update`)\nThis path is used when CSS is imported in JavaScript (e.g., `import './style.css'`). Vite transforms the CSS into a JS module.\n- **Transformation**: The `cssPostPlugin` (`packages/vite/src/node/plugins/css.ts`, line 592) transforms the CSS into JS code:\n  ```javascript\n  import { updateStyle, removeStyle } from \"/@vite/client\"\n  const __vite__id = \"/path/to/style.css\"\n  const __vite__css = \"...content...\"\n  updateStyle(__vite__id, __vite__css)\n  import.meta.hot.accept()\n  import.meta.hot.prune(() => __vite__removeStyle(__vite__id))\n  ```\n- **Client Handling**:\n    1. The client receives a `js-update` and triggers the standard HMR runtime to re-import the module.\n    2. Execution of the new JS module calls `updateStyle`.\n    3. `updateStyle` (in `client.ts`, line 548) looks for a `<style>` tag with a matching `data-vite-dev-id`.\n    4. If found, it updates the `textContent` directly. If not, it creates a new `<style>` tag and appends it to the `<head>`.\n\n### 4. Dependency Tracking\nFor CSS preprocessors (Sass, Less) or `@import` rules, the `cssAnalysisPlugin` (`packages/vite/src/node/plugins/css.ts`, line 1170) records these dependencies in the `ModuleGraph`. This ensures that changing a \"partial\" file (like `_variables.scss`) correctly triggers an HMR update for the root CSS file that imports it.","evidence":[{"step":"search_code(query='CSS HMR update')","detail":"Search results for 'CSS HMR update' (10 result(s)):\n\n  1. packages/vite/src/node/server/environments/fullBundleEnvironment.ts [HmrOutput] (type, semantic)\n     Score: 0.0164\n     | type HmrOutput = Bi..."},{"step":"read_file(path='packages/vite/src/node/plugins/css.ts')","detail":"File: packages/vite/src/node/plugins/css.ts\n────────────────────────────────────────────────────────────\n     1 | import fs from 'node:fs'\n     2 | import fsp from 'node:fs/promises'\n     3 | import p..."},{"step":"read_file(path='packages/vite/src/node/server/hmr.ts')","detail":"File: packages/vite/src/node/server/hmr.ts\n────────────────────────────────────────────────────────────\n     1 | import fsp from 'node:fs/promises'\n     2 | import path from 'node:path'\n     3 | impor..."},{"step":"search_code(query='hotUpdate(')","detail":"Search results for 'hotUpdate(' (10 result(s)):\n\n  1. packages/vite/src/node/server/index.ts [hot] (method, semantic)\n     Score: 0.0164\n     | set hot(h) {\n     |       hot = h\n     |     }\n\n  2. pla..."},{"step":"read_file(path='packages/vite/src/node/plugins/css.ts', end_line=1200, start_line=900)","detail":"File: packages/vite/src/node/plugins/css.ts (lines 900-1200)\n────────────────────────────────────────────────────────────\n   900 |                     return finalizeCss(chunkCSS!, config)\n   901 |   ..."},{"step":"read_file(start_line=400, end_line=600, path='packages/vite/src/node/server/hmr.ts')","detail":"File: packages/vite/src/node/server/hmr.ts (lines 400-600)\n────────────────────────────────────────────────────────────\n   400 |     try {\n   401 |       await restartServerWithUrls(server)\n   402 |  ..."},{"step":"read_file(end_line=1000, path='packages/vite/src/node/server/hmr.ts', start_line=601)","detail":"File: packages/vite/src/node/server/hmr.ts (lines 601-1000)\n────────────────────────────────────────────────────────────\n   601 |             `(${environment.name}) [no modules matched] ${colors.dim(s..."},{"step":"search_code(query='updateModules(')","detail":"Search results for 'updateModules(' (10 result(s)):\n\n  1. packages/vite/src/node/__tests__/plugins/importGlob/fixture-a/index.ts [basicWithObjectValues] (variable, semantic)\n     Score: 0.0164\n     | ..."},{"step":"read_file(path='packages/vite/src/node/server/moduleGraph.ts', end_line=100, start_line=1)","detail":"File: packages/vite/src/node/server/moduleGraph.ts (lines 1-100)\n────────────────────────────────────────────────────────────\n     1 | import { extname } from 'node:path'\n     2 | import type { Module..."},{"step":"read_file(end_line=1300, path='packages/vite/src/node/plugins/css.ts', start_line=1180)","detail":"File: packages/vite/src/node/plugins/css.ts (lines 1180-1300)\n────────────────────────────────────────────────────────────\n  1180 |       },\n  1181 |       async handler(_, id) {\n  1182 |         cons..."},{"step":"read_file(start_line=1, end_line=1000, path='packages/vite/src/client/client.ts')","detail":"File: packages/vite/src/client/client.ts (lines 1-660)\n────────────────────────────────────────────────────────────\n     1 | import type {\n     2 |   DevRuntime as DevRuntimeType,\n     3 |   Messenger..."},{"step":"resolve_symbol(action='definition', symbol_name='isDirectCSSRequest')","detail":"Definition of 'isDirectCSSRequest' (SCIP, 1 result(s)):\n  packages/vite/src/node/plugins/css.ts:262\n[Iteration 5/15, 12 tool calls used]"},{"step":"read_file(end_line=600, path='packages/vite/src/node/plugins/css.ts', start_line=450)","detail":"File: packages/vite/src/node/plugins/css.ts (lines 450-600)\n────────────────────────────────────────────────────────────\n   450 |       },\n   451 |     },\n   452 |   }\n   453 | }\n   454 | \n   455 | /*..."},{"step":"read_file(end_line=610, start_line=601, path='packages/vite/src/node/plugins/css.ts')","detail":"File: packages/vite/src/node/plugins/css.ts (lines 601-610)\n────────────────────────────────────────────────────────────\n   601 |             // css modules exports change on edit so it can't self acc..."},{"step":"search_code(query='function updateStyle')","detail":"Search results for 'function updateStyle' (10 result(s)):\n\n  1. packages/vite/src/client/client.ts [updateStyle] (function, semantic)\n     Score: 0.0164\n     | function updateStyle(id: string, content..."},{"step":"read_file(path='packages/vite/src/client/client.ts', end_line=530, start_line=480)","detail":"File: packages/vite/src/client/client.ts (lines 480-530)\n────────────────────────────────────────────────────────────\n   480 |           close()\n   481 |         }\n   482 |         function close() {\n..."},{"step":"read_file(end_line=580, start_line=531, path='packages/vite/src/client/client.ts')","detail":"File: packages/vite/src/client/client.ts (lines 531-580)\n────────────────────────────────────────────────────────────\n   531 |     .querySelectorAll<HTMLStyleElement>('style[data-vite-dev-id]')\n   532..."}]}